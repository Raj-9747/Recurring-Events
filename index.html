<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recurring Task Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        .day-chip {
            display: inline-flex;
            align-items: center;
            gap: .5rem;
            padding: .35rem .65rem;
            border: 1px solid #e5e7eb;
            border-radius: .5rem;
            cursor: pointer;
            transition: all .18s ease;
            background: #fff
        }

        .day-chip:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(2, 6, 23, 0.04)
        }

        .day-chip.selected {
            background: #1e40af;
            color: #fff;
            border-color: transparent
        }

        tbody tr {
            transition: transform .12s ease, box-shadow .12s ease
        }

        tbody tr:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(2, 6, 23, 0.06)
        }

        .disabled-btn {
            opacity: .6;
            cursor: not-allowed;
        }

        .msg-success {
            color: #065f46
        }

        .msg-error {
            color: #991b1b
        }
    </style>
</head>

<body class="bg-gray-100 p-10">

    <div class="max-w-5xl mx-auto">

        <!-- FORM SECTION -->
        <div class="bg-white p-8 rounded shadow-lg mb-10">
            <h2 class="text-2xl font-bold mb-6 text-gray-800" id="formTitle">Create Recurring Event Series</h2>

            <form id="taskForm" class="space-y-4">
                <input type="hidden" id="editBatchId">

                <div>
                    <label class="block text-sm font-medium text-gray-700">Team Member</label>
                    <input type="text" value="Shafoli" disabled
                        class="mt-1 block w-full p-2 border border-gray-300 rounded bg-gray-100 text-gray-500 cursor-not-allowed">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700">Event Title</label>
                    <input type="text" id="eventTitle" required placeholder="e.g. Client Meeting"
                        class="mt-1 block w-full p-2 border border-gray-300 rounded">
                </div>

                <div id="daysContainer">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Select Days (Multiple)</label>

                    <div class="flex flex-wrap gap-3">
                        <label class="day-chip"><input type="checkbox" name="day" value="1" class="mr-2"> Mon</label>
                        <label class="day-chip"><input type="checkbox" name="day" value="2" class="mr-2"> Tue</label>
                        <label class="day-chip"><input type="checkbox" name="day" value="3" class="mr-2"> Wed</label>
                        <label class="day-chip"><input type="checkbox" name="day" value="4" class="mr-2"> Thu</label>
                        <label class="day-chip"><input type="checkbox" name="day" value="5" class="mr-2"> Fri</label>
                        <label class="day-chip"><input type="checkbox" name="day" value="6" class="mr-2"> Sat</label>
                        <label class="day-chip"><input type="checkbox" name="day" value="0" class="mr-2"> Sun</label>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Start Time</label>
                        <input type="time" id="startTime" required class="mt-1 block w-full p-2 border border-gray-300 rounded">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">End Time</label>
                        <input type="time" id="endTime" required class="mt-1 block w-full p-2 border border-gray-300 rounded">
                    </div>
                </div>

                <div class="flex gap-2">
                    <button type="submit" id="submitBtn"
                        class="flex-1 bg-blue-600 text-white p-3 rounded hover:bg-blue-700 font-semibold">
                        Generate 50 Events
                    </button>

                    <button type="button" id="cancelBtn" onclick="resetForm()"
                        class="hidden flex-none bg-gray-500 text-white p-3 rounded">
                        Cancel Edit
                    </button>
                </div>
            </form>

            <div id="message" class="mt-4 text-center font-medium hidden"></div>
        </div>

        <!-- LIST SECTION -->
        <div class="bg-white p-8 rounded shadow-lg">
            <h3 class="text-xl font-bold mb-4 text-gray-800">Active Event Series</h3>

            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th class="px-6 py-3">Series Info</th>
                            <th class="px-6 py-3">Title</th>
                            <th class="px-6 py-3">Time</th>
                            <th class="px-6 py-3">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="taskTableBody"></tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        const supabaseUrl = "https://fraheqsgfwbjnmmodzfa.supabase.co";
        const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZyYWhlcXNnZndiam5tbW9kemZhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3NTc3NzQsImV4cCI6MjA3MzMzMzc3NH0.yCyUsd27MbluxEhmZ2cjp6gcpgIJyHCjR7I55WU-R90";
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

        const taskForm = document.getElementById("taskForm");
        const messageDiv = document.getElementById("message");
        const taskTableBody = document.getElementById("taskTableBody");

        fetchTasks();

        // Convert local date+time â†’ Pure UTC HH:MM:SS
        function toUTC(timeStr, dateObj) {
            const [h, m] = timeStr.split(":").map(Number);
            const local = new Date(dateObj);
            local.setHours(h, m, 0, 0);
            const utc = new Date(local.toUTCString());
            return utc.toISOString().split("T")[1].substring(0, 8); // HH:MM:SS
        }

        taskForm.addEventListener("submit", async (e) => {
            e.preventDefault();

            const title = document.getElementById("eventTitle").value;
            const startTime = document.getElementById("startTime").value;
            const endTime = document.getElementById("endTime").value;
            const editBatchId = document.getElementById("editBatchId").value;

            const checkboxes = document.querySelectorAll("input[name='day']:checked");

            let selectedDays = [];
            checkboxes.forEach(cb => selectedDays.push(parseInt(cb.value)));

            if (selectedDays.length === 0) {
                alert("Select at least one day.");
                return;
            }

            // If editing, update existing tasks
            if (editBatchId) {
                // Delete existing tasks for this batch
                const { error: deleteError } = await supabaseClient
                    .from("recurring_tasks")
                    .delete()
                    .eq("batch_id", editBatchId);

                if (deleteError) {
                    showMessage("Error updating tasks", "red");
                    return;
                }
            }

            const batchId = editBatchId || "batch_" + Date.now();
            const tasksToInsert = [];

            let count = 0, offset = 0;

            while (count < 50) {
                let date = new Date();
                date.setDate(date.getDate() + offset);

                if (selectedDays.includes(date.getDay())) {
                    const isoDate = date.toISOString().split("T")[0];

                    tasksToInsert.push({
                        team_member: "Shafoli",
                        event_title: title,
                        event_date: isoDate,
                        start_time: toUTC(startTime, date),
                        end_time: toUTC(endTime, date),
                        batch_id: batchId
                    });

                    count++;
                }
                offset++;
            }

            const { error } = await supabaseClient.from("recurring_tasks").insert(tasksToInsert);

            if (error) {
                showMessage("Error saving tasks", "red");
                return;
            }

            showMessage(editBatchId ? "Events updated successfully!" : "50 recurring tasks created in UTC!", "green");
            resetForm();
            fetchTasks();
        });

        async function fetchTasks() {
            const { data } = await supabaseClient.from("recurring_tasks").select("*");

            taskTableBody.innerHTML = "";

            // Group tasks by batch_id
            const batches = {};
            data.forEach(task => {
                if (!batches[task.batch_id]) {
                    batches[task.batch_id] = [];
                }
                batches[task.batch_id].push(task);
            });

            // Display one row per batch
            Object.keys(batches).forEach(batchId => {
                const batchTasks = batches[batchId];
                const firstTask = batchTasks[0];
                
                // Get unique days from the batch
                const days = [...new Set(batchTasks.map(t => {
                    const date = new Date(t.event_date);
                    return date.getDay();
                }))].sort((a, b) => a - b);

                taskTableBody.insertAdjacentHTML("beforeend", `
                    <tr>
                        <td class="px-6 py-4">${firstTask.batch_id}</td>
                        <td class="px-6 py-4">${firstTask.event_title}</td>
                        <td class="px-6 py-4">${firstTask.start_time} - ${firstTask.end_time}</td>
                        <td class="px-6 py-4">
                            <button onclick="editBatch('${batchId}')" class="text-blue-600 hover:text-blue-800 cursor-pointer font-medium">Edit</button>
                        </td>
                    </tr>
                `);
            });
        }

        async function editBatch(batchId) {
            // Fetch all tasks for this batch
            const { data, error } = await supabaseClient
                .from("recurring_tasks")
                .select("*")
                .eq("batch_id", batchId);

            if (error || !data || data.length === 0) {
                showMessage("Error loading batch data", "red");
                return;
            }

            const firstTask = data[0];
            
            // Get unique days from the batch
            const days = [...new Set(data.map(t => {
                const date = new Date(t.event_date);
                return date.getDay();
            }))];

            // Populate form
            document.getElementById("editBatchId").value = batchId;
            document.getElementById("eventTitle").value = firstTask.event_title;
            
            // Convert UTC time back to local time for display
            const startTimeUTC = firstTask.start_time;
            const endTimeUTC = firstTask.end_time;
            
            // Create a date object and set UTC time, then get local time
            const tempDate = new Date();
            const [startH, startM] = startTimeUTC.split(":").map(Number);
            const [endH, endM] = endTimeUTC.split(":").map(Number);
            
            tempDate.setUTCHours(startH, startM, 0, 0);
            const localStart = new Date(tempDate);
            const startTimeStr = String(localStart.getHours()).padStart(2, '0') + ':' + String(localStart.getMinutes()).padStart(2, '0');
            
            tempDate.setUTCHours(endH, endM, 0, 0);
            const localEnd = new Date(tempDate);
            const endTimeStr = String(localEnd.getHours()).padStart(2, '0') + ':' + String(localEnd.getMinutes()).padStart(2, '0');
            
            document.getElementById("startTime").value = startTimeStr;
            document.getElementById("endTime").value = endTimeStr;

            // Check the day checkboxes
            document.querySelectorAll("input[name='day']").forEach(cb => {
                cb.checked = days.includes(parseInt(cb.value));
            });

            // Update UI for edit mode
            document.getElementById("formTitle").textContent = "Edit Recurring Event Series";
            document.getElementById("submitBtn").textContent = "Update Events";
            document.getElementById("cancelBtn").classList.remove("hidden");

            // Scroll to form
            document.querySelector(".bg-white.p-8.rounded.shadow-lg.mb-10").scrollIntoView({ behavior: "smooth" });
        }

        function showMessage(msg, type) {
            messageDiv.textContent = msg;
            messageDiv.className = `mt-4 text-center font-medium ${type === "green" ? "msg-success" : "msg-error"}`;
            messageDiv.classList.remove("hidden");
        }

        function resetForm() {
            taskForm.reset();
            document.getElementById("editBatchId").value = "";
            document.getElementById("formTitle").textContent = "Create Recurring Event Series";
            document.getElementById("submitBtn").textContent = "Generate 50 Events";
            document.getElementById("cancelBtn").classList.add("hidden");
            messageDiv.classList.add("hidden");
        }
    </script>

</body>
</html>
